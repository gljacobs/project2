<!DOCTYPE html>
<html>
<head>
	<title>test</title>
	 <script src="https://code.jquery.com/jquery.js"></script>
	 <style type="text/css">
	 	#loader {
	 		width: 100vw;
	 		min-height: 100vh;
	 		z-index: 9999;
	 		position: fixed;
	 		background-color: rgba(255,255,255,.7);
	 		color: blue;
	 		text-align: center;
	 		padding-top: 10%;
	 	}
	 	.hide {
	 		display: none;
	 	}
	 </style>
</head>
<body>
<div id="loader" class="hide">
	<img src="https://thumbs.gfycat.com/InfantileSpiritedGoldenretriever-max-1mb.gif" title="loading..." alt="loading..." aria-label="data is loading please wait.">
	<h1>LOADING...</h1>
</div>


<h1> Upload Image </h1>
<form id="survey">
       
    <div>
        <input id="status" type="textArea" class="validate" name="status" required>
        <label for="status">Text Area</label>
    </div>

    <div>
        <input id="image" type="file" class="validate" name="image" required>
       <label for="image">Upload a photo</label>
    </div>
    <div>
    	<input type="submit" value="Submit" id="submit">
	</div>

</form>

  <img id="match-image"/>

    <div id="match-status">
    </div>











<h1> Post Models </h1>

<div>
    <input id="postText" type="textArea" name="postText" required>
    <input type="submit" value="Post" id="post">
</div>

<div>
    <input type="submit" value="GetPost" id="getpost">
     <div id="getpostDisplay"><div>
</div>







<h1></h1>






 <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script>



function getUser(id, cb)
{
     $.get("api/users/" + id).
             then(function(data) {
              console.log(data);
              cb(data)
            });
}









$(document).ready(function () {

const userId = 1;





    $("#submit").click(function (e) {
    	$("#loader").removeClass("hide");
        $("#match-image").attr("src", "");
        $("#survey")[0].reportValidity();
        e.preventDefault();
        var formIsValid = $("#survey")[0].checkValidity();
        var user = new FormData();

        console.log(user);

        if (formIsValid) {
            var status = $("#status").val().trim();
            var image = $("#image").prop("files")[0]; 


            user.append('status', status);
            user.append("file", image);
   				
   			$("#status").val("")
       		$("#image").val("")




             $.get("/api/users/1", function(data) {
                console.log(data);
            });



            $.ajax({
                type: "POST",
                url: "/test",
                processData: false,
                contentType: false,
                dataType: "json",
                data: user, 
                success: function(response, textStatus, jqXHR) {
                    if(response === null) {
                       alert("Error.");
                    } else {
                    	$("#loader").addClass("hide");
                    	console.log("post back");
                       $("#match-status").text(response.status);
                       $("#match-image").attr("src", `https://gymateproject2.s3.us-west-1.amazonaws.com/${response.image}.jpg`);}
                }
            })
        } else {
            alert("Check form and resubmit");
        }



    })








     $("#getpost").click(function (e) {


            $.get("api/posts").
             then(function(data) {

              console.log(data);
              for (var i = 0; i < data.length; i ++)
              {
                cb = function (i, userData)
                {
                    username = userData.name;
                    console.log(username);
                    console.log(i);
                    console.log(data[i].content);
                    $("#getpostDisplay").append(username + ": " + data[i].content);
                    $("#getpostDisplay").append("<br>");

                }
                getUser(data[i].UserId, cb.bind(null,i));
              }
            });


     });






     $("#post").click(function (e) {



        var postText = $("#postText").val().trim();


        var postText = {

            content: $("#postText").val().trim(),
            userId: userId
         };
 
             $.post("api/posts", postText).
             then(function(data) {

              console.log(data);

              alert("Adding post...");
            });
    })
















})

</script>
   


</body>
</html>