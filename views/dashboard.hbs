<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Gymate</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="dash.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body>
    <nav role="navigation red" class="nav">
        <div class="nav-wrapper container">
            <a id="logo-container" href="#" class="brand-logo">
                <img src="gm-white.png" id="logo">
            </a>
            <ul class="right">{{#if user}}

                {{/if}}</ul>
            <ul class="right">
                {{#if user}}
                <a style="color:red" href="/logout">Sign out</a>
                {{else}}
                <a style="color:red" href="/login">Sign in</a>
                {{/if}}
            </ul>
            <ul class="right">{{#if user}}
                <a style="color:red" href="/profile">
                    Profile
                </a>
                {{/if}}</ul>
        </div>
    </nav>

    <br>

    <div class="container" id="main">

        <div class="card-panel">
            <span><h5 id="navi" data-email={{user.profile.email}}>{{user.profile.email}}</h5><span>
            <span class="card-title">Popular Routines</span>
            <div class="carousel">
                <a class='routine carousel-item' data-index = "0">Starting Strength</a>
                <a class='routine carousel-item' data-index = "1">Consistent Cardio</a>
                <a class='routine carousel-item' data-index = "2">Guide to Gains</a>
                <a class='routine carousel-item' data-index = "3">Zen Yoga</a>
                <a class='routine carousel-item' data-index = "4">Long Distance Training</a>
            </div>
        </div>

        <div class="row">
            <div class="col s6">
                <div class="card-panel">
                    <span class="card-title">You vs. Buddy</span>
                    <table class="centered">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Since</th>
                                <th>Hours (Total)</th>
                                <th>Pounds Loss (Total)</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr>
                                <td>You</td>
                                <td id = "date"></td>
                                <td id = "hours"></td>
                                <td id = "pounds"></td>
                             
                            </tr>
                            <tr>
                                <td>Gabe</td>
                                <td >2019-07-11</td>
                                <td>60</td>
                                <td>7</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col s6">
                <div class="card-panel">
                    <span class="card-title">Posts</span>
                    <div class="row">
                        <form class="col s12">
                            <div class="row">
                                <div class="input-field col s12">
                                    <textarea id="textarea1" class="materialize-textarea"></textarea>
                                    <label for="textarea1">How was your workout?</label>
                                    <button id="send-post" class="btn waves-effect waves-light" type="submit"
                                        name="action">Send</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <ul class="collection"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="modal1" class="modal">
        <div class="modal-content">
            <h4>Starting Strength</h4>
            <table>
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Routine Info</th>
                    </tr>
                </thead>

                <tbody>
                    <tr>
                        <td>Monday</td>
                        <td>
                            <div class="input-field inline routine-info" id="day1">3x5: Squat, Bench Press, Overhead Press
                                <!--        <input id="email_inline" type="email" class="validate">
                                                <label for="email_inline">Routine Info</label> -->
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>Tuesday</td>
                        <td>
                            <div class="input-field inline routine-info" id="day2">Rest
                                <!--        <input id="email_inline" type="email" class="validate">
                                                <label for="email_inline">Routine Info</label> -->
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>Wednesday</td>
                        <td>
                            <div class="input-field inline routine-info" id="day3">3x5: Squat, Bench Press, Deadlift
                                <!--                         <input id="email_inline" type="email" class="validate">
                                                <label for="email_inline">Routine Info</label> -->
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>Thursday</td>
                        <td>
                            <div class="input-field inline routine-info" id="day4">Rest
                                <!--    <input id="email_inline" type="email" class="validate">
                                                <label for="email_inline">Routine Info</label> -->
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>Friday</td>
                        <td>
                            <div class="input-field inline routine-info" id="day5">3x5: Squat, Bench Press, Overhead Press
                                <!--            <input id="email_inline" type="email" class="validate">
                                                <label for="email_inline">Routine Info</label> -->
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>Saturday</td>
                        <td>
                            <div class="input-field inline routine-info" id="day6">Rest
                                <!--    <input id="email_inline" type="email" class="validate">
                                                <label for="email_inline">Routine Info</label> -->
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>Sunday</td>
                        <td>
                            <div class="input-field inline routine-info" id="day7">Rest
                                <!--  <input id="email_inline" type="email" class="validate">
                                                <label for="email_inline">Routine Info</label> -->
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <div class="row">
                <div class="col s6">
                    <a id="add-routine" href="#!"
                        class="modal-action modal-close waves-effect waves-green btn-large btn-accept submit">Add Routine</a>
                </div>
            </div>
        </div>
    </div>

    <nav role="navigation red" class="nav">
        <div class="nav-wrapper container">
            <div class="container center">
                <footer>Â© 2019 Copyright</footer>
            </div>
        </div>
    </nav>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>

<script>
    var colors = ["red", "yellow", "green", "blue", "orange", "purple"];
    var email;
    var buddyId;
    var routineIndex;
    var selected = false;
    var userId;









    function getUser(id, cb) {
        $.get("api/users/" + id).
            then(function (data) {
                console.log(data);
                cb(data)
            });
    };

    function getUserByEmail(email) {
        $.get("api/users/email/" + email).
            then(function (data) {
                console.log(data);
               userId  = data.id;

            });
    };

   
    var Routine1 = ["3x5: Squat, Bench Press, Overhead Press", "Rest", "3x5: Squat, Bench Press, Deadlift", "Rest", "3x5: Squat, Bench Press, Overhead Press", "Rest", "Rest"];
    var Routine2 = ["Chest, Shoulders and Triceps", "Back and Biceps", "Rest", "Legs", "Rest", "Shoulders, chest, and Triceps", "Back and Bis", "Rest"];
    var Routine3 = ["Chest & Back", "Legs", "Shoulders & Arms", "Rest", " Chest, Shoulders, & Triceps", "Back & Biceps", " Legs"];
    var Routine4 = ["Chest, Shoulders and Triceps", "Back and Biceps", "Rest", "Legs", "Rest", "Shoulders, chest, and Triceps", "Back and Bis", "Rest"];
    var Routine5 = ["Chest, Shoulders and Triceps", "Back and Biceps", "Rest", "Legs", "Rest", "Shoulders, chest, and Triceps", "Back and Bis", "Rest"];

     var routineArr = [Routine1, Routine2, Routine3, Routine4, Routine5];

    //$(".carousel").append("<a class='carousel-item'>R1</a>");
    //$(".carousel").append("<a class='carousel-item'>R2</a>");
    //$(".carousel").append("<a class='carousel-item'>R3</a>");
    //$(".carousel").append("<a class='carousel-item'>R4</a>");
    //$(".carousel").append("<a class='carousel-item'>R5</a>");
    var routineImg = ["dumbbell.png", "runer-silhouette-running-fast.png", "dumbbell.png", "stretching-exercises.png", "runer-silhouette-running-fast.png"];

    $(".carousel-item").each(function (index) {
        $(this).attr("style", `background: ${colors[index]}; background-image: url(${routineImg[index]}); background-size:50%; background-repeat:no-repeat; background-position:center;`);
    });




    function updateUserRoutine(routine, userId) {

         for (var i = 0; i < 7;i ++)
            {
                  var dailyRoutine = 
                {
                    hoursChecked: 0,
                    routine: routine[i],
                }
                    $.ajax({
                    url: "/api/routines/" + userId + "/" + (i+1),
                    type: 'PUT',    
                    data: dailyRoutine  
                    }).then(function(data) {

                });
            }
    }



    function addRoutine(routine) {

        console.log(routine);

        for (var i = 0; i < 7; i++) {
            var dailyRoutine =
            {

                dayOfTheWeek: i + 1,
                routine: routine[i],
                UserId: userId
            }

            $.ajax({
                method: "POST",
                url: "/api/routines/" + userId,
                data: dailyRoutine
            }).then(function (data) {

                console.log(data);
            });
        }

    }



  function displayUserStats() {
           
            $.get("/api/stats/" + userId, function (data) {

                console.log(data);
                if(data.length !== 0)
                {
                console.log("in display", data);
                console.log("weight", data[0].weight);
                console.log("time", data[0].time);

                var hours = 0;
                var poundsLossed = (data[data.length - 1].poundsLossed);

                var time = data[data.length - 1].time;
                time = time.slice(0, 10);
                $("#date").text(time);
                $("#pounds").text(poundsLossed);

                for (var i = 0; i < data.length; i++ ) {
                    hours = data[i].hours + hours;
                }

                $("#hours").text(hours);
              }
            });
        }

 function displayAllPosts() {
        $.get("api/posts").
            then(function (data) {

                console.log(data);
                for (var i = 0; i < data.length; i++) {

                    cb = function (i, userData) {
                        var post = $("<li class='collection-item avatar'>");
                        var imgId = "post-img" + i;
                        var nameId = "post-name" + i;
                        var contentId = "post-content" + i;

                        post.append(`<img id='${imgId}' class='circle'>`);
                        post.append(`<span id='${nameId}' class='title'></span>`);
                        post.append(`<p id='${contentId}'>`);

                        $(".collection").append(post);

                        $("#" + imgId).attr('src', userData.profilePhoto);
                        $("#" + nameId).text(userData.name);
                        $("#" + contentId).text(data[i].content);


                    }
                    getUser(data[i].UserId, cb.bind(null, i));
                }
            });


    };

    
   

    $(document).ready(function () {
        email = JSON.stringify($("#navi").text());

        console.log(email);
        var index = email.length - 1;
        email = email.slice(1, index);
        console.log(email);

        getUserByEmail(email);
        console.log(email);

        setTimeout(function(){ 

             displayUserStats();

               }, 1000);
        

        $(".routine").click(function(){
            routineIndex = $(this).attr("data-index");
            console.log(routineIndex);
            $('.modal').modal();
            $('#modal1').modal('open');
            $('.trigger-modal').modal();
        }); 

        $("#add-routine").click(function (e) {
            e.preventDefault();

         $.get("/api/routines/" + userId, function (data) {
        if(data.length === 0)
            {
                addRoutine(routineArr[0]);
            }
        else
        {
            updateUserRoutine(routineArr[routineIndex], userId);
        }
    });

        });

        $('.carousel').carousel();
        displayAllPosts();

        $("#send-post").on("click", (e) => {
            e.preventDefault();




            var contentToPost = $("#textarea1").val().trim();
            // if(!contentId) {
            //     alert()
            // }
            $("#textarea1").val("");
            $("#textarea1").next().removeClass("active");

            var postText = {

                content: contentToPost,
                userId: userId
                // userId: userId
            };


            $.post("api/posts", postText).
                then(function (data) {

                    console.log(data);


                });
            $(".collection").empty();
            displayAllPosts();
        });
    });
</script>

</html>